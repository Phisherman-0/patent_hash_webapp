import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import path from "path";

export default defineConfig(({ mode }) => {
  const isProduction = mode === 'production';
  
  return {
    plugins: [react()],
    logLevel: 'warn',
    resolve: {
      alias: {
        "@": path.resolve(__dirname, "src"),
        "@shared": path.resolve(__dirname, "../shared"),
        "@assets": path.resolve(__dirname, "../attached_assets"),
        // Polyfills for problematic modules
        "buffer": "buffer",
        "pino": path.resolve(__dirname, "src/polyfills/pino.js"),
      },
    },
    server: {
      port: 3000,
      // Allow external connections
      host: '0.0.0.0',
      proxy: {
        "/api": {
          target: process.env.VITE_PROXY_TARGET || "http://localhost:5000",
          changeOrigin: true,
          secure: false,
          rewrite: (path) => path,
        },
        "/health": {
          target: process.env.VITE_PROXY_TARGET || "http://localhost:5000",
          changeOrigin: true,
          secure: false,
        },
      },
      fs: {
        strict: true,
        deny: ["**/.*"],
      },
    },
    esbuild: {
      logOverride: { 'this-is-undefined-in-esm': 'silent' }
    },
    build: {
      outDir: "dist",
      emptyOutDir: true,
      sourcemap: false,
      minify: isProduction ? 'esbuild' : false,
      rollupOptions: {
        output: {
          manualChunks: {
            vendor: ['react', 'react-dom'],
            ui: ['@radix-ui/react-dialog', '@radix-ui/react-select', '@radix-ui/react-tabs'],
            charts: ['recharts'],
            hedera: ['@hashgraph/sdk', '@hashgraph/hedera-wallet-connect'],
          },
        },
      },
    },
    optimizeDeps: {
      include: [
        '@hashgraph/sdk',
        '@hashgraph/hedera-wallet-connect',
        '@noble/curves/secp256k1',
        '@noble/hashes/sha2',
        '@noble/hashes/utils',
        '@noble/hashes/hmac',
        'multiformats/basics',
        'buffer',
        'pino',
      ],
      exclude: [
        // Exclude all walletconnect packages that cause issues
        '@walletconnect/*',
        '@web3modal/*',
        'pino-pretty',
        'pino-http',
      ],
      esbuildOptions: {
        target: 'esnext',
        supported: {
          'top-level-await': true
        },
        logLevel: 'silent'
      }
    },
    define: {
      __APP_VERSION__: JSON.stringify(process.env.npm_package_version),
      global: 'globalThis',
      'process.env.NODE_ENV': JSON.stringify(mode),
      // Polyfills for Node.js globals
      'process.platform': JSON.stringify('browser'),
      'process.env': JSON.stringify({}),
    },
  };
});